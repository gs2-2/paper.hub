<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>My test</title>
	<link rel="stylesheet" href="vendor/jquery-ui/themes/smoothness/jquery-ui.css">

	<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

    <!-- CSS
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="vendor/skeleton/css/normalize.css">
    <link rel="stylesheet" href="vendor/skeleton/css/skeleton.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/index.css">



	<script language="javascript" type="text/javascript" src="vendor/jquery/dist/jquery.min.js"></script>
	<script language="javascript" type="text/javascript" src="vendor/jquery-ui/jquery-ui.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/flot.js/jquery.flot.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/flot.js/jquery.flot.time.min.js"></script>

	<script language="javascript" type="text/javascript" src="js/flot.js/jquery.flot.navigate.min.js"></script>

	<script language="javascript" type="text/javascript" src="js/flot.js/jquery.flot.selection.min.js"></script>
		<script language="javascript" type="text/javascript" src="js/flot.js/jquery.flot.stack.min.js"></script>
	<script language="javascript" type="text/javascript" src="vendor/moment/moment.js"></script>
	<script language="javascript" type="text/javascript" src="js/statistics.js"></script>

	<script type="text/javascript" src="js/changeColor.js"></script>
	<script type="text/javascript">

	$(function() {

		
		// create example datasets
		var datasets = [{"label":"rural","data":[[2001,20.1],[2002,22.3],[2003,24.4],[2004,20.1],[2005,20.6],[2006,21.1],[2007,19.4],[2008,18.8],[2009,19.3],[2010,19.9]]},{"label":"urban","data":[[2001,28.1],[2002,29.3],[2003,32.8],[2004,27.3],[2005,27.6],[2006,29.2],[2007,26.9],[2008,25.8],[2009,26.9],[2010,26.7]]},{"label":"traffic","data":[[2001,32.1],[2002,33.8],[2003,35.8],[2004,31.1],[2005,31.6],[2006,33.1],[2007,31.1],[2008,30.3],[2009,29.8],[2010,29.4]]}];

		// add headline
		$('#lineSelector').append("<p style='text-align: center; margin-bottom: 0'>Select series</p>");
		
		// add checkboxes for each series
		$.each(datasets, function(key, val){
			$('#lineSelector').append("<input type='checkbox' name='" + key + "' checked='checked' id='id" + key + "'></input>" + "<label style='text-align: right; display: inline-block; padding-right: 0.5em;' for='id" + key + "'>" + val.label + "</label>");
		});

		// on click update graph and only show selected series
		$('#lineSelector').find('input').click(plotSelection);

		var munin = [
			'#00cc00',
			'#0066b3',
			'#ff8000',
			'#ffcc00',
			'#330099',
			'#990099',
			'#ccff00',
			'#ff0000',
			'#808080',
			'#008f00',
			'#00487d',
			'#b35a00',
			'#b38f00',
			'#6b006b',
			'#8fb300',
			'#b30000',
			'#bebebe',
			'#80ff80',
			'#80c9ff',
			'#ffc080',
			'#ffe680',
			'#aa80ff',
			'#ee00cc',
			'#ff8080',
			'#666600',
			'#ffbfff',
			'#00ffcc',
			'#cc6699',
			'#999900'
		];
		var colorwheel = [
			'#b5b6a9',
			'#858772',
			'#785f43',
			'#96557e',
			'#4682b4',
			'#65b9ac',
			'#73c03a',
			'#cb513a'
		].reverse();

		var spectrum14 = [
			'#ecb796',
			'#dc8f70',
			'#b2a470',
			'#92875a',
			'#716c49',
			'#d2ed82',
			'#bbe468',
			'#a1d05d',
			'#e7cbe6',
			'#d8aad6',
			'#a888c2',
			'#9dc2d3',
			'#649eb9',
			'#387aa3'
		].reverse();



		var options = {
					xaxis: {
						//mode: 'time',
					},
					yaxis: {
						autoscaleMargin: 0.02
					},
					grid: {hoverable: true, borderWidth: 0.5},
					series: {
						lines: {show: true},
						points: {show: true}
					},

					//zoom: {interactive: false},
					//pan: {interactive: false},
					colors: munin
				};

		    
		
		// draw graph
		function plotSelection(){
			var data = [];
			

			// check which series are selected
			$('#lineSelector').find('input:checked').each(function(){
				var key = $(this).attr('name');
				if (key && datasets[key]){
					data.push(datasets[key]);
				}
			});

			// if series exist, plot them
			if(data.length > 0){

				//plot data
				var plot = $.plot('#placeholder', data, options);


				

				var allDataSelected = [];
				for (var i=0; i<plot.getData().length; i++){
					var allDataLines = {data: []};
					for(var j=0; j<plot.getData()[i].data.length; j++){
						allDataLines.data.push(plot.getData()[i].data[j][1]);
					}
					allDataSelected.push(allDataLines);
				}
				
				getStats(allDataSelected);
				
				

				



				//plot slider
				var slider = $.plot('#slider', data, {
					legend: {
						show: false
					},
					xaxis: {
						show: false
					},
					yaxis: {
						show: false
					},
					grid: {
						borderWidth: 0.5
					},
					series: {
						lines: {
							show: true,
							lineWidth: 1
						},
						shadowSize: 0
					},
					selection: {
						mode: "x"
					}
				});

				
			}

			// add tooltip
			$('<div id="tooltip"></div>').css({
				position: 'absolute',
				display: 'none',
				border: '1px solid #fdd',
				padding: '2px',
				'background-color' : '#fee',
				opacity: 0.80
			}).appendTo('body');

			// add tooltip hover functionality
			$('#placeholder').bind('plothover', function(event, pos, item){
				if(item){
					var x = item.datapoint[0].toFixed(2),
					y = item.datapoint[1].toFixed(2);
					x = parseInt(x);
					var date = moment(x).format('MMM Do YYYY HH:mm:ss');
					$('#tooltip').html('<b>' + item.series.label + '</b><br>' + date.toString() + '<br> y: ' + y).css({top: item.pageY+5, left: item.pageX+5}).fadeIn(200);
				} else {
					$('#tooltip').hide();
				}
			});


			//functionality for slider
			$('#slider').bind('plotselected', function(event, ranges){
				
				console.log(ranges.xaxis.from);
				// change zoom of plot
				plot = $.plot(placeholder, data,
                          $.extend(true, {}, options, {
                              xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to }
                          }));


				// create variable selection and push selected data into it
				var selection = [];
				console.log(plot.getData());
				for (var i=0; i< plot.getData().length; i++){
					var line = {data: []};
					for (var j=0; j<plot.getData()[i].data.length; j++){


						//ranges.xaxis.from contains most left x-value of drawn selection
						//ranges.xaxis.to contains most right x-value of drawn selection
						if((plot.getData()[i].data[j][0] >= ranges.xaxis.from) && (plot.getData()[i].data[j][0] <= ranges.xaxis.to)){
							line.data.push(plot.getData()[i].data[j][1]); 
							

						}
					}
					selection.push(line);
					console.log(selection);

				}

				getStats(selection);
				

			});



			/*
			* @Desc calls statsTime() and puts result into table
			* @Param selection, data in actual viewport
			*/
			function getStats(selection){
				$('#row').empty();

				var histoSeries = [];
				
				//iterate over selection, calculate statistics and put result into table
				$.each(selection, function(index, value){

					// get statistics
					var statistics = stats(value.data);

					//get histogramm Data
					var histoStats = prepareHisto(value.data);
					histoSeries.push(histoStats);

					// fill table
					$('#row').append('<tr><td>'+plot.getData()[index].label+'</td><td>'+statistics.mean+'</td><td>'+statistics.variance+'</td><td>'+statistics.standardDev+'</td><td>'+statistics.quantiles.quarter+'</td><td>'+statistics.quantiles.half+'</td><td>'+statistics.quantiles.threequarter+'</td><td>'+statistics.min+'</td><td>'+statistics.max+'</td></tr>');
				
				});
				


				// set plot options for histogramm
				var histoOptions = {
					legend: {show: false},
					grid: {
						hoverable: true, 
						borderWidth: 0.5
					},
					series: {
						lines: {show: false},
						bars: {
							show: true,
							barWidth: 0.5,
							lineWidth: 1

						},
						stack: 0
					},
					colors: munin
				};

				//plot histogramm
				var histogramm = $.plot('#histo', histoSeries, histoOptions);
				

				// add tooltip
				$('<div id="tooltipHisto"></div>').css({
					position: 'absolute',
					display: 'none',
					border: '1px solid #fdd',
					padding: '2px',
					'background-color' : '#fee',
					opacity: 0.80
				}).appendTo('body');



				// add tooltip hover functionality
				$('#histo').bind('plothover', function(event, pos, item){
					
					if(item){
						
						var x = item.datapoint[0].toFixed(2),
						y = item.datapoint[1];
						
						
						$('#tooltipHisto').html('<br> <b>value:</b> ' + x + '<br> <b>#appearance:</b> ' + y).css({top: item.pageY+5, left: item.pageX+5}).fadeIn(200);
					} else {
						$('#tooltipHisto').hide();
					}
				});

				//console.log(histoSeries);
				var controls = new colorControls({
					element: document.querySelector('form'),
					plot: plot,
					histgram: histo,
					histOptions: histoOptions,
					histData: histoSeries,
					options: options,
					data: data
				});
			}




		}

		

		plotSelection();
		


		

	});

	

	</script>
</head>
<body style="font-family: Helvetica, Arial, sans-serif">
		
		<div id="placeholder" style="width: 100%; height: 400px"></div>
		<div id="slider" style="width: 96.5%; left: 2%; height: 50px"></div>
		<div id="lineSelector" style="width: 48%; height: 3em; float: left; padding-left: 2%; text-align: center;"></div>
		<div id="color_chooser" style="width: 48%; height: 3em; float: right; padding-left: 2%;">
			<form id="color_form" class="rickshaw_legend" style="height: 30px, width: 60px">
				<p style="text-align: center; margin-bottom: 0">Select color</p>
				<div id="renderer_form" class="toggler" style="text-align: center">
					<input type="radio" name="color" id="munin" value="Munin" checked>
					<label for="munin" style="text-align: right; padding-right: 0.5em; display: inline-block">Munin</label>
					<input type="radio" name="color" id="colorwheel" value="Colorwheel">
					<label for="colorwheel" style="text-align: right; padding-right: 0.5em; display: inline-block">Colorwheel</label>
					<input type="radio" name="color" id="spectrum14" value="Spectrum14">
					<label for="spectrum14" style="text-align: right; padding-right: 0.5em; display: inline-block">Spectrum14</label>
				</div>
			</form>
		</div>
		
		
		<div id="statistics" style="width: 100%; display: inline-block; padding-left: 2%;">
			
			<table style="float: left; padding-left: 2%">
			<thead>
			<tr>
				<th colspan="1">Series</th><th colspan="1">Mean</th>
				<th colspan="1">Variance</th><th colspan="1">StdDev</th>
				<th colspan="3" style="text-align: center">Quantiles<br>25% 50% 75%</th>
				<th colspan="1">Min</th><th colspan="1">Max</th>
			</tr>
			</thead>
			<tbody id="row">
			</tbody>
			</table>

			<div id="histo" style="float: right; width: 44%; height: 220px; padding-left: 2% !important; padding-right: 2% !important"></div>

		</div>
		

</body>
</html>
